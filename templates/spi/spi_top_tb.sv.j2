//------------------------------------------------------------------------------
// SPI Top-Level Testbench
// Generated by VerifAI - Natural Language to UVM Testbench Generator
//------------------------------------------------------------------------------

`timescale 1ns/1ps

`include "uvm_macros.svh"

module {{ module_name }}_spi_top_tb;
    
    import uvm_pkg::*;
    import {{ module_name }}_spi_pkg::*;
    
    //--------------------------------------------------------------------------
    // Parameters
    //--------------------------------------------------------------------------
    parameter CLK_PERIOD = {{ clock_period | default(10) }};  // ns
    parameter DATA_WIDTH = {{ data_width | default(8) }};
    parameter NUM_SLAVES = {{ spi_num_slaves | default(1) }};
    
    //--------------------------------------------------------------------------
    // Clock and Reset
    //--------------------------------------------------------------------------
    logic clk;
    logic rst_n;
    
    // Clock generation
    initial begin
        clk = 0;
        forever #(CLK_PERIOD/2) clk = ~clk;
    end
    
    // Reset generation
    initial begin
        rst_n = 0;
        repeat(10) @(posedge clk);
        rst_n = 1;
        `uvm_info("TOP_TB", "Reset de-asserted", UVM_LOW)
    end
    
    //--------------------------------------------------------------------------
    // SPI Interface Instantiation
    //--------------------------------------------------------------------------
    spi_if #(
        .DATA_WIDTH(DATA_WIDTH),
        .NUM_SLAVES(NUM_SLAVES)
    ) spi_vif (
        .clk(clk),
        .rst_n(rst_n)
    );
    
    //--------------------------------------------------------------------------
    // DUT Instantiation (Placeholder - Replace with actual DUT)
    //--------------------------------------------------------------------------
    
    // Example: Simple loopback for testing
    // Connect MOSI to MISO with one clock delay for basic testing
    logic miso_loopback;
    
    always_ff @(posedge spi_vif.sclk or negedge rst_n) begin
        if (!rst_n)
            miso_loopback <= 1'b0;
        else if (spi_vif.cs_n == '0)  // Any slave selected
            miso_loopback <= spi_vif.mosi;  // Simple loopback
    end
    
    assign spi_vif.miso = miso_loopback;
    
    // TODO: Replace loopback with actual DUT instantiation
    // {{ module_name }} dut (
    //     .clk     (clk),
    //     .rst_n   (rst_n),
    //     .sclk    (spi_vif.sclk),
    //     .cs_n    (spi_vif.cs_n[0]),
    //     .mosi    (spi_vif.mosi),
    //     .miso    (spi_vif.miso)
    // );
    
    //--------------------------------------------------------------------------
    // Interface Initialization
    //--------------------------------------------------------------------------
    initial begin
        spi_vif.init();
    end
    
    //--------------------------------------------------------------------------
    // UVM Configuration and Test Execution
    //--------------------------------------------------------------------------
    initial begin
        // Register interface in config DB
        uvm_config_db#(virtual spi_if)::set(null, "*", "vif", spi_vif);
        
        // Waveform dumping (VCS)
        `ifdef VCS
            $vcdpluson;
            $vcdplusmemon;
        `endif
        
        // Waveform dumping (Questa/ModelSim)
        `ifdef QUESTA
            $wlfdumpvars(0, {{ module_name }}_spi_top_tb);
        `endif
        
        // Generic VCD dumping
        `ifdef DUMP_VCD
            $dumpfile("{{ module_name }}_spi.vcd");
            $dumpvars(0, {{ module_name }}_spi_top_tb);
        `endif
        
        // Run test
        run_test();
    end
    
    //--------------------------------------------------------------------------
    // Timeout Watchdog
    //--------------------------------------------------------------------------
    initial begin
        #{{ timeout | default(1000000) }}ns;
        `uvm_fatal("TOP_TB", "Test timeout - simulation exceeded maximum time")
    end
    
    //--------------------------------------------------------------------------
    // Protocol Checker Instance (Optional)
    //--------------------------------------------------------------------------
    
    // Simple protocol checks at top level
    always @(posedge clk) begin
        if (rst_n) begin
            // Check: SCLK should not toggle when all CS are high
            // (This is a soft check - some designs may allow it)
        end
    end
    
    //--------------------------------------------------------------------------
    // Debug Helpers
    //--------------------------------------------------------------------------
    
    // Transaction counter
    int transaction_count = 0;
    
    always @(posedge spi_vif.cs_n[0]) begin
        if (rst_n) begin
            transaction_count++;
            `uvm_info("TOP_TB", $sformatf("Transaction #%0d completed", transaction_count), UVM_HIGH)
        end
    end
    
    // SCLK edge counter for current transaction
    int sclk_edges = 0;
    
    always @(negedge spi_vif.cs_n[0]) begin
        sclk_edges = 0;
    end
    
    always @(posedge spi_vif.sclk) begin
        if (spi_vif.cs_n[0] == 0) begin
            sclk_edges++;
        end
    end
    
endmodule : {{ module_name }}_spi_top_tb
