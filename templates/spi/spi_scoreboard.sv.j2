//------------------------------------------------------------------------------
// SPI Scoreboard
// Generated by VerifAI - Natural Language to UVM Testbench Generator
//------------------------------------------------------------------------------

`ifndef SPI_SCOREBOARD_SV
`define SPI_SCOREBOARD_SV

class spi_scoreboard extends uvm_scoreboard;
    
    `uvm_component_utils(spi_scoreboard)
    
    //--------------------------------------------------------------------------
    // Analysis Exports
    //--------------------------------------------------------------------------
    uvm_analysis_imp #(spi_seq_item, spi_scoreboard) master_export;
    
    //--------------------------------------------------------------------------
    // Expected Data Storage
    //--------------------------------------------------------------------------
    spi_seq_item expected_queue[$];
    
    //--------------------------------------------------------------------------
    // Statistics
    //--------------------------------------------------------------------------
    int unsigned num_writes;
    int unsigned num_reads;
    int unsigned num_matches;
    int unsigned num_mismatches;
    int unsigned num_transactions;
    
    // Per-slave statistics
    int unsigned slave_transactions[SPI_NUM_SLAVES];
    
    //--------------------------------------------------------------------------
    // Configuration
    //--------------------------------------------------------------------------
    bit enable_checking = 1;
    bit enable_ordering_check = 1;
    
    //--------------------------------------------------------------------------
    // Constructor
    //--------------------------------------------------------------------------
    
    function new(string name = "spi_scoreboard", uvm_component parent = null);
        super.new(name, parent);
    endfunction
    
    //--------------------------------------------------------------------------
    // Build Phase
    //--------------------------------------------------------------------------
    
    virtual function void build_phase(uvm_phase phase);
        super.build_phase(phase);
        master_export = new("master_export", this);
        
        // Initialize slave statistics
        for (int i = 0; i < SPI_NUM_SLAVES; i++) begin
            slave_transactions[i] = 0;
        end
    endfunction
    
    //--------------------------------------------------------------------------
    // Write Method (from analysis port)
    //--------------------------------------------------------------------------
    
    virtual function void write(spi_seq_item item);
        num_transactions++;
        
        // Update per-slave stats
        if (item.slave_select < SPI_NUM_SLAVES) begin
            slave_transactions[item.slave_select]++;
        end
        
        // Update operation stats
        case (item.operation)
            SPI_WRITE:     num_writes++;
            SPI_READ:      num_reads++;
            SPI_WRITE_READ: begin
                num_writes++;
                num_reads++;
            end
        endcase
        
        // Check against expected if checking is enabled
        if (enable_checking) begin
            check_transaction(item);
        end
        
        `uvm_info("SPI_SB", $sformatf("Received transaction #%0d:\n%s", 
                  num_transactions, item.convert2string()), UVM_HIGH)
    endfunction
    
    //--------------------------------------------------------------------------
    // Add Expected Transaction
    //--------------------------------------------------------------------------
    
    virtual function void add_expected(spi_seq_item expected);
        spi_seq_item item_copy;
        item_copy = spi_seq_item::type_id::create("expected_copy");
        item_copy.copy(expected);
        expected_queue.push_back(item_copy);
        
        `uvm_info("SPI_SB", $sformatf("Added expected transaction, queue size: %0d", 
                  expected_queue.size()), UVM_HIGH)
    endfunction
    
    //--------------------------------------------------------------------------
    // Check Transaction
    //--------------------------------------------------------------------------
    
    virtual function void check_transaction(spi_seq_item actual);
        spi_seq_item expected;
        bit found = 0;
        
        if (expected_queue.size() == 0) begin
            `uvm_info("SPI_SB", "No expected transactions to compare", UVM_HIGH)
            return;
        end
        
        if (enable_ordering_check) begin
            // Strict ordering - check first in queue
            expected = expected_queue.pop_front();
            compare_transactions(expected, actual);
        end else begin
            // Search for matching transaction
            foreach (expected_queue[i]) begin
                if (expected_queue[i].slave_select == actual.slave_select &&
                    expected_queue[i].mosi_data == actual.mosi_data) begin
                    expected = expected_queue[i];
                    expected_queue.delete(i);
                    found = 1;
                    break;
                end
            end
            
            if (found) begin
                compare_transactions(expected, actual);
            end else begin
                `uvm_warning("SPI_SB", "No matching expected transaction found")
            end
        end
    endfunction
    
    //--------------------------------------------------------------------------
    // Compare Transactions
    //--------------------------------------------------------------------------
    
    virtual function void compare_transactions(spi_seq_item expected, spi_seq_item actual);
        bit match = 1;
        string mismatch_msg = "";
        
        // Compare slave select
        if (expected.slave_select != actual.slave_select) begin
            match = 0;
            mismatch_msg = {mismatch_msg, $sformatf("Slave: exp=%0d, act=%0d; ", 
                           expected.slave_select, actual.slave_select)};
        end
        
        // Compare MOSI data
        if (expected.mosi_data != actual.mosi_data) begin
            match = 0;
            mismatch_msg = {mismatch_msg, $sformatf("MOSI: exp=0x%0h, act=0x%0h; ", 
                           expected.mosi_data, actual.mosi_data)};
        end
        
        // Compare mode
        if (expected.mode != actual.mode) begin
            match = 0;
            mismatch_msg = {mismatch_msg, $sformatf("Mode: exp=%s, act=%s; ", 
                           expected.mode.name(), actual.mode.name())};
        end
        
        if (match) begin
            num_matches++;
            `uvm_info("SPI_SB", $sformatf("Transaction MATCH #%0d", num_matches), UVM_MEDIUM)
        end else begin
            num_mismatches++;
            `uvm_error("SPI_SB", $sformatf("Transaction MISMATCH #%0d: %s", 
                       num_mismatches, mismatch_msg))
        end
    endfunction
    
    //--------------------------------------------------------------------------
    // Report Phase
    //--------------------------------------------------------------------------
    
    virtual function void report_phase(uvm_phase phase);
        string report;
        
        report = "\n";
        report = {report, "╔══════════════════════════════════════════════════════════════╗\n"};
        report = {report, "║                  SPI Scoreboard Report                       ║\n"};
        report = {report, "╠══════════════════════════════════════════════════════════════╣\n"};
        report = {report, $sformatf("║  Total Transactions  : %-10d                          ║\n", num_transactions)};
        report = {report, $sformatf("║  Write Operations    : %-10d                          ║\n", num_writes)};
        report = {report, $sformatf("║  Read Operations     : %-10d                          ║\n", num_reads)};
        report = {report, "╠══════════════════════════════════════════════════════════════╣\n"};
        report = {report, $sformatf("║  Matches             : %-10d                          ║\n", num_matches)};
        report = {report, $sformatf("║  Mismatches          : %-10d                          ║\n", num_mismatches)};
        report = {report, "╠══════════════════════════════════════════════════════════════╣\n"};
        report = {report, "║  Per-Slave Statistics:                                       ║\n"};
        
        for (int i = 0; i < SPI_NUM_SLAVES; i++) begin
            report = {report, $sformatf("║    Slave[%0d]          : %-10d                          ║\n", 
                      i, slave_transactions[i])};
        end
        
        report = {report, "╠══════════════════════════════════════════════════════════════╣\n"};
        
        if (num_mismatches == 0 && expected_queue.size() == 0)
            report = {report, "║  STATUS: ✓ PASSED                                            ║\n"};
        else
            report = {report, "║  STATUS: ✗ FAILED                                            ║\n"};
        
        if (expected_queue.size() > 0)
            report = {report, $sformatf("║  WARNING: %0d expected transactions not received            ║\n", 
                      expected_queue.size())};
        
        report = {report, "╚══════════════════════════════════════════════════════════════╝\n"};
        
        `uvm_info("SPI_SB", report, UVM_LOW)
    endfunction
    
    //--------------------------------------------------------------------------
    // Check Phase
    //--------------------------------------------------------------------------
    
    virtual function void check_phase(uvm_phase phase);
        super.check_phase(phase);
        
        if (num_mismatches > 0) begin
            `uvm_error("SPI_SB", $sformatf("Test completed with %0d mismatches", num_mismatches))
        end
        
        if (expected_queue.size() > 0) begin
            `uvm_warning("SPI_SB", $sformatf("%0d expected transactions were not observed", 
                         expected_queue.size()))
        end
    endfunction
    
endclass : spi_scoreboard

`endif // SPI_SCOREBOARD_SV
