//------------------------------------------------------------------------------
// SPI Base Test
// Generated by VerifAI - Natural Language to UVM Testbench Generator
//------------------------------------------------------------------------------

`ifndef SPI_BASE_TEST_SV
`define SPI_BASE_TEST_SV

class spi_base_test extends uvm_test;
    
    `uvm_component_utils(spi_base_test)
    
    //--------------------------------------------------------------------------
    // Environment
    //--------------------------------------------------------------------------
    spi_env env;
    
    //--------------------------------------------------------------------------
    // Virtual Interface
    //--------------------------------------------------------------------------
    virtual spi_if vif;
    
    //--------------------------------------------------------------------------
    // Test Configuration
    //--------------------------------------------------------------------------
    int unsigned test_timeout = 100000;  // Default timeout in ns
    
    //--------------------------------------------------------------------------
    // Constructor
    //--------------------------------------------------------------------------
    
    function new(string name = "spi_base_test", uvm_component parent = null);
        super.new(name, parent);
    endfunction
    
    //--------------------------------------------------------------------------
    // Build Phase
    //--------------------------------------------------------------------------
    
    virtual function void build_phase(uvm_phase phase);
        super.build_phase(phase);
        
        // Get virtual interface
        if (!uvm_config_db#(virtual spi_if)::get(this, "", "vif", vif)) begin
            `uvm_fatal("SPI_TEST", "Virtual interface not found")
        end
        
        // Create environment
        env = spi_env::type_id::create("env", this);
        
        `uvm_info("SPI_TEST", $sformatf("Test '%s' build complete", get_name()), UVM_LOW)
    endfunction
    
    //--------------------------------------------------------------------------
    // End of Elaboration Phase
    //--------------------------------------------------------------------------
    
    virtual function void end_of_elaboration_phase(uvm_phase phase);
        super.end_of_elaboration_phase(phase);
        uvm_top.print_topology();
    endfunction
    
    //--------------------------------------------------------------------------
    // Run Phase
    //--------------------------------------------------------------------------
    
    virtual task run_phase(uvm_phase phase);
        phase.raise_objection(this, "Starting test");
        
        `uvm_info("SPI_TEST", "=== Test Started ===", UVM_LOW)
        
        // Wait for reset
        wait_for_reset();
        
        // Run the test sequence
        run_test_sequence(phase);
        
        // Drain time
        #1000ns;
        
        `uvm_info("SPI_TEST", "=== Test Completed ===", UVM_LOW)
        
        phase.drop_objection(this, "Test complete");
    endtask
    
    //--------------------------------------------------------------------------
    // Wait for Reset
    //--------------------------------------------------------------------------
    
    virtual task wait_for_reset();
        `uvm_info("SPI_TEST", "Waiting for reset...", UVM_MEDIUM)
        @(posedge vif.rst_n);
        repeat(5) @(posedge vif.clk);
        `uvm_info("SPI_TEST", "Reset complete", UVM_MEDIUM)
    endtask
    
    //--------------------------------------------------------------------------
    // Run Test Sequence (Override in derived tests)
    //--------------------------------------------------------------------------
    
    virtual task run_test_sequence(uvm_phase phase);
        spi_random_seq seq;
        
        `uvm_info("SPI_TEST", "Running default random sequence", UVM_MEDIUM)
        
        seq = spi_random_seq::type_id::create("seq");
        seq.start(env.get_master_sequencer());
    endtask
    
    //--------------------------------------------------------------------------
    // Report Phase
    //--------------------------------------------------------------------------
    
    virtual function void report_phase(uvm_phase phase);
        uvm_report_server svr;
        int unsigned error_count;
        
        super.report_phase(phase);
        
        svr = uvm_report_server::get_server();
        error_count = svr.get_severity_count(UVM_ERROR) + svr.get_severity_count(UVM_FATAL);
        
        `uvm_info("SPI_TEST", "════════════════════════════════════════", UVM_LOW)
        if (error_count == 0) begin
            `uvm_info("SPI_TEST", "           ✓ TEST PASSED", UVM_LOW)
        end else begin
            `uvm_info("SPI_TEST", $sformatf("           ✗ TEST FAILED (%0d errors)", error_count), UVM_LOW)
        end
        `uvm_info("SPI_TEST", "════════════════════════════════════════", UVM_LOW)
    endfunction
    
endclass : spi_base_test

//==============================================================================
// Basic Write Test
//==============================================================================

class spi_write_test extends spi_base_test;
    
    `uvm_component_utils(spi_write_test)
    
    function new(string name = "spi_write_test", uvm_component parent = null);
        super.new(name, parent);
    endfunction
    
    virtual task run_test_sequence(uvm_phase phase);
        spi_single_write_seq seq;
        
        `uvm_info("SPI_TEST", "Running write test", UVM_MEDIUM)
        
        // Multiple writes with different data
        for (int i = 0; i < 10; i++) begin
            seq = spi_single_write_seq::type_id::create($sformatf("seq_%0d", i));
            seq.write_data = i * 16 + i;  // Some pattern
            seq.start(env.get_master_sequencer());
        end
    endtask
    
endclass : spi_write_test

//==============================================================================
// Read Test
//==============================================================================

class spi_read_test extends spi_base_test;
    
    `uvm_component_utils(spi_read_test)
    
    function new(string name = "spi_read_test", uvm_component parent = null);
        super.new(name, parent);
    endfunction
    
    virtual task run_test_sequence(uvm_phase phase);
        spi_single_read_seq seq;
        
        `uvm_info("SPI_TEST", "Running read test", UVM_MEDIUM)
        
        for (int i = 0; i < 10; i++) begin
            seq = spi_single_read_seq::type_id::create($sformatf("seq_%0d", i));
            seq.start(env.get_master_sequencer());
            `uvm_info("SPI_TEST", $sformatf("Read data: 0x%0h", seq.read_data), UVM_MEDIUM)
        end
    endtask
    
endclass : spi_read_test

//==============================================================================
// Full Duplex Test
//==============================================================================

class spi_full_duplex_test extends spi_base_test;
    
    `uvm_component_utils(spi_full_duplex_test)
    
    function new(string name = "spi_full_duplex_test", uvm_component parent = null);
        super.new(name, parent);
    endfunction
    
    virtual task run_test_sequence(uvm_phase phase);
        spi_write_read_seq seq;
        
        `uvm_info("SPI_TEST", "Running full duplex test", UVM_MEDIUM)
        
        for (int i = 0; i < 10; i++) begin
            seq = spi_write_read_seq::type_id::create($sformatf("seq_%0d", i));
            seq.randomize();
            seq.start(env.get_master_sequencer());
        end
    endtask
    
endclass : spi_full_duplex_test

//==============================================================================
// Mode Sweep Test (Tests all 4 SPI modes)
//==============================================================================

class spi_mode_sweep_test extends spi_base_test;
    
    `uvm_component_utils(spi_mode_sweep_test)
    
    function new(string name = "spi_mode_sweep_test", uvm_component parent = null);
        super.new(name, parent);
    endfunction
    
    virtual task run_test_sequence(uvm_phase phase);
        spi_mode_sweep_seq seq;
        
        `uvm_info("SPI_TEST", "Running mode sweep test", UVM_MEDIUM)
        
        repeat(3) begin
            seq = spi_mode_sweep_seq::type_id::create("seq");
            seq.start(env.get_master_sequencer());
        end
    endtask
    
endclass : spi_mode_sweep_test

//==============================================================================
// Multi-Slave Test
//==============================================================================

class spi_multi_slave_test extends spi_base_test;
    
    `uvm_component_utils(spi_multi_slave_test)
    
    function new(string name = "spi_multi_slave_test", uvm_component parent = null);
        super.new(name, parent);
    endfunction
    
    virtual task run_test_sequence(uvm_phase phase);
        spi_all_slaves_seq seq;
        
        `uvm_info("SPI_TEST", "Running multi-slave test", UVM_MEDIUM)
        
        repeat(5) begin
            seq = spi_all_slaves_seq::type_id::create("seq");
            seq.start(env.get_master_sequencer());
        end
    endtask
    
endclass : spi_multi_slave_test

//==============================================================================
// Walking Pattern Test (Data Integrity)
//==============================================================================

class spi_walking_test extends spi_base_test;
    
    `uvm_component_utils(spi_walking_test)
    
    function new(string name = "spi_walking_test", uvm_component parent = null);
        super.new(name, parent);
    endfunction
    
    virtual task run_test_sequence(uvm_phase phase);
        spi_walking_pattern_seq seq;
        
        `uvm_info("SPI_TEST", "Running walking pattern test", UVM_MEDIUM)
        
        // Walking ones
        seq = spi_walking_pattern_seq::type_id::create("walking_ones");
        seq.pattern = spi_walking_pattern_seq::WALKING_ONES;
        seq.start(env.get_master_sequencer());
        
        // Walking zeros
        seq = spi_walking_pattern_seq::type_id::create("walking_zeros");
        seq.pattern = spi_walking_pattern_seq::WALKING_ZEROS;
        seq.start(env.get_master_sequencer());
    endtask
    
endclass : spi_walking_test

//==============================================================================
// Stress Test (Burst and Random)
//==============================================================================

class spi_stress_test extends spi_base_test;
    
    `uvm_component_utils(spi_stress_test)
    
    function new(string name = "spi_stress_test", uvm_component parent = null);
        super.new(name, parent);
    endfunction
    
    virtual task run_test_sequence(uvm_phase phase);
        spi_burst_seq burst_seq;
        spi_random_seq random_seq;
        
        `uvm_info("SPI_TEST", "Running stress test", UVM_MEDIUM)
        
        // Run multiple bursts
        for (int i = 0; i < 5; i++) begin
            burst_seq = spi_burst_seq::type_id::create($sformatf("burst_%0d", i));
            burst_seq.randomize();
            burst_seq.start(env.get_master_sequencer());
        end
        
        // Random traffic
        random_seq = spi_random_seq::type_id::create("random");
        random_seq.num_transactions = 50;
        random_seq.start(env.get_master_sequencer());
    endtask
    
endclass : spi_stress_test

`endif // SPI_BASE_TEST_SV
